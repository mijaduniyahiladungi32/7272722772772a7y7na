name: Auto Update Playlist every 15 minutes

on:
  schedule:
    - cron: "*/15 * * * *"   # every 15 minutes
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.API_U1 }}
          token: ${{ secrets.API_U2 }}
          ref: main

      - name: Download new playlist and add credit header
        run: |
          # Download the playlist
          curl -L -o playlist_raw.m3u "${{ secrets.API_U3 }}"

          # Get BD time (Asia/Dhaka)
          BD_TIME=$(TZ='Asia/Dhaka' date '+%Y-%m-%d %H:%M')

          # Add credit header + downloaded content
          echo "# Playlist By Abu SAEEID
# By Abu SAEEID X Noob https://t.me/abusaeeidx
# Github https://github.com/abusaeeidx/
# Iptv telegram channels https://t.me/xfireflix
# Last update: ${BD_TIME} BD time
" > playlist.m3u

          cat playlist_raw.m3u >> playlist.m3u

      - name: Commit and push if playlist changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet playlist.m3u; then
            echo "âœ… No changes detected"
          else
            git add playlist.m3u
            git commit -m "Update playlist.m3u automatically"
            git push origin main
          fi
